{% comment %}
Template include for form fields with classes and their corresponding
error messages, if necessary.
{% endcomment %}
{% load static field_helpers url_helpers %}
{% load custom_filters %}

{% load widget_tweaks %}

{% if widget.attrs.maxlength %}
<div class="usa-character-count">
{% endif %}

{% if field.use_fieldset %}
  <fieldset
    id="{{ widget.attrs.id }}__fieldset"
    class="usa-fieldset usa-form-group{% if group_classes %} {{ group_classes }}{% endif %}"
  >
{% elif field.widget_type == 'checkbox' %}
  <div
    class="usa-checkbox{% if group_classes %} {{ group_classes }}{% endif %}"
  >
{% else %}
  <div
    class="usa-form-group{% if group_classes %} {{ group_classes }}{% endif %}"
  >
{% endif %}

  {% if not field.widget_type == "checkbox" %}
    {% if show_edit_button %}
      <div class="grid-row flex-align-baseline">
        <div class="grid-col">
          {% include "django/forms/label.html" %}
        </div>
        <div class="grid-col">
          <button type="button" class="usa-button usa-button--unstyled">Edit</button>
        </div>
      </div>
    {% else %}
      {% include "django/forms/label.html" %}
    {% endif %}
  {% endif %}

  {% if sublabel_text %}
    <p id="{{ widget.attrs.id }}__sublabel" class="text-base margin-top-2px margin-bottom-1">
      {% comment %} If the link_text appears more than once, the first instance will be a link and the other instances will be ignored {% endcomment %}
      {% if link_text and link_text in sublabel_text %}
        {% with link_index=sublabel_text|find_index:link_text %}
          {{ sublabel_text|slice:link_index }}
          {% comment %} HTML will convert a new line into a space, resulting with a space before the fullstop in case link_text is at the end of sublabel_text, hence the unfortunate line below {% endcomment %}
          <a {% if external_link == "true" %}rel="noopener noreferrer" class="usa-link usa-link--external" {% endif %}{% if target_blank == "true" %}target="_blank" {% endif %}href="{{ link_href }}">{{ link_text }}</a>{% with sublabel_part_after=sublabel_text|slice_after:link_text %}{{ sublabel_part_after }}{% endwith %}
        {% endwith %}
      {% else %}
        {{ sublabel_text }}
      {% endif %}
    </p>
  {% endif %} 

  {% if field.errors %}
    <div id="{{ widget.attrs.id }}__error-message">
    {% for error in field.errors %}
      <span class="usa-error-message" role="alert">
        {{ error }}
      </span>
    {% endfor %}
    </div>
  {% endif %}

  {% if append_gov %}
    <div class="display-flex flex-align-center">
  {% endif %}

  {% if show_edit_button %}
    <div id="{{field.name}}__edit-button-value" class="input-with-edit-button {%if not field.value and field.field.required %}input-with-edit-button__error{% endif %}">
      <svg class="usa-icon" aria-hidden="true" focusable="false" role="img" width="24" height="24">
        {% if field.value or not field.field.required %}
        <use xlink:href="{%static 'img/sprite.svg'%}#check_circle"></use>
        {%elif not field.value %}
        <use xlink:href="{%static 'img/sprite.svg'%}#error"></use>
        {%endif %}
      </svg>
      <div class="display-inline padding-left-05 margin-left-3 readonly-field">
        {{ field.value }}
      </div>
    </div>
    {# this is the input field, itself #}
    {% include widget.template_name %}
  {% else %}
      {# this is the input field, itself #}
      {% include widget.template_name %}
  {% endif %}
  {% if append_gov %}
      <span class="padding-top-05 padding-left-2px">.gov </span>
    </div>
  {% endif %}

  {% if field.widget_type == "checkbox" %}
    {% include "django/forms/label.html" %}
  {% endif %}

{% if field.use_fieldset %}
  </fieldset>
{% else %}
  </div>
{% endif %}

{% if widget.attrs.maxlength %}
  <span
    id="{{ widget.attrs.id }}__message"
    class="usa-character-count__message"
    aria-live="polite"
  >
    You can enter up to {{ widget.attrs.maxlength }} characters
  </span>

</div>
{% endif %}
